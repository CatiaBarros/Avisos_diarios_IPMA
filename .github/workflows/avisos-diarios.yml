- name: Verificar altera√ß√µes significativas e comitar se necess√°rio
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    git config --global user.name 'github-actions[bot]'
    git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    git add *.csv

    if git diff --cached --quiet; then
      echo "üü° Sem altera√ß√µes nos CSVs."
      if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
        echo "‚ÑπÔ∏è Execu√ß√£o manual ‚Äî sem altera√ß√µes relevantes. Nenhum commit foi feito."
      fi
      exit 0
    fi

    ALTERACOES_UTEIS=$(git diff --cached \
      | grep -E '^\+|^\-' \
      | grep -vE '^(---|\+\+\+)' \
      | grep -vE '(Sem informa√ß√£o@@0|NA)' || true)

    if [ -n "$ALTERACOES_UTEIS" ]; then
      echo "‚úÖ Encontradas altera√ß√µes relevantes:"
      echo "$ALTERACOES_UTEIS"
      TZ=Europe/Lisbon git commit -m "üì¶ Atualiza√ß√£o IPMA com altera√ß√µes relevantes - $(date +"%Y-%m-%d %Hh")"
      git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
      git push origin HEAD:main
    else
      echo "üü° Apenas altera√ß√µes triviais (Sem informa√ß√£o ou NA). Commit ignorado."
      if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
        echo "‚ÑπÔ∏è Execu√ß√£o manual ‚Äî sem altera√ß√µes √∫teis. Nenhum commit foi feito."
      fi
    fi
